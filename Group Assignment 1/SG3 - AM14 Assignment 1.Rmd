---
title: "AM14 Assignment 1"
subtitle:  "Prices, Returns, and Portfolio Theory"
author: "Study Group 3: Alberto Lambert, Sammy Chen, Shuhan Li, Michael Gritzbach, Mehek Khanna"
output: html_document
---

------------------------

# OUR STRATEGY

## DEADLINE

IDEAL DEADLINE = 21:00 SUNDAY 17TH JANUARY 2021
INTERNAL DEADLINE = 21:00 WEDNESDAY 20TH JANUARY 2021
OFFICIAL DEADLINE = 21:00 FRIDAY, 22ND JANUARY 2021

## TEAMS

### TEAM A: Q1-Q12 - Sammy & Alberto
### TEAM B: Q13-Q15 - Michael, Mehek & Shuhan

### DAY 1 (FRIDAY 15TH JANUARY)

TEAM A: Q1-Q12 FINALISATION
TEAM B: MACHINE LEARNING INDIVIDUAL ASSIGNMENT

### DAY 2 (SATURDAY 16TH JANUARY)

TEAM A: Q1-Q12 FINALISATION
TEAM B: MACHINE LEARNING INDIVIDUAL ASSIGNMENT

### DAY 3 (SUNDAY 17TH JANUARY)

TEAM A: ASSISTANCE
TEAM B: Q13-Q15 FINALISATION

### DAY 4 (MONDAY 18TH JANUARY)

TEAM A: ASSISTANCE
TEAM B: Q13-Q15 FINALISATION

-------------------------

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Importing Packages

```{r load_libraries}
library(readxl)
library(tidyverse)
library(lubridate)
library(PerformanceAnalytics)
library(ggthemes)
library(ggtext)
library(patchwork)

```

> 1. Go to CANVAS and download the data for PS1 Monthly.xlsx. The data was downloaded from the CRSP (The Center for Research in Security Prices) data base via WRDS (Wharton Research Service) that is available for LBS students. Note the file contains data about Microsoft, Exxon Mobil (previously Exxon), General Electric, JP Morgan Chase (previously Chemical Banking and Chase Manhattan), Intel, Citigroup (previously Primerica and Travellers Group). In addition, the columns vwretd (ewretd) and vwredx (ewretx) contain value-weighted (equal-weighted) total returns and total returns excluding dividends for the CRSP index that contains stocks from NYSE, AMEX, and NASDAQ. Finally, sprtrn contains the total return for the S&P 500 Composite Index.

# Loading in the Data

```{r loading_monthly_data}

#loading in PS1 monthly data
PS1_Monthly <- read_excel("PS1_Monthly.xlsx") %>% 
  mutate(DATE = lubridate::ymd(date)) %>% #fix `date`
  select(1,2,19,3:18) #reorder the columns logically

#addressing missingness in DIVAMT by imputing with 0
PS1_Monthly[is.na(PS1_Monthly)] <- 0

```

> 2. Make sure you understand how the holding period returns (RET) are calculated given the (unadjusted) prices (PRC), dividends (DIVAMT) and adjustment for the number of shares (CFACPR, i.e., the adjusted price equals PRC/CFACPR). That is, replicate the returns using the raw data. You can find more information about the variables on the CRSP page online. Calculate returns where you omit the dividends, i.e., you focus solely on capital gains (call these returns RETX).

```{r creating_testing_dataframe}

#creating a testing data frame
testing <- PS1_Monthly %>% 
  select(3,4,9,7,13,10,14)

```

**The Calculation of Holding Period Returns (RET) is as follows:**

$RET_t \ = \ \frac{(PRC_t + DIVAMT_t)/CFACPR_t}{PRC_{t-1}/CFACPR_{t-1}}-1$

```{r calculating_RET}

#calculating RET from PRC, DIVAMT and CFACPR
testing <- testing %>% 
  group_by(TICKER) %>% 
  mutate(RET_rep = round(((((PRC+DIVAMT)/CFACPR)/(lag(PRC)/lag(CFACPR)))-1),6)) %>% 
  ungroup()
           
#evaluating whether this calculation was successful
summary(testing$RET==testing$RET_rep)

#we find NAs for the first REP of each TICKER, which makes sense since there is no prior period - these are recoded to 0
testing[is.na(testing)] <- 0

#there are 69 values for which my REP_rep does not match REP

```

**The Calculation of Holding Period Returns, Omitting Dividends (RETX) is as follows:**

$RETX_t \ = \ \frac{(PRC_t)/CFACPR_t}{PRC_{t-1}/CFACPR_{t-1}}-1$

```{r calculating_RETX}

#calculating RETX
testing <- testing %>% 
  group_by(TICKER) %>% 
  mutate(RETX_rep = round(((((PRC)/CFACPR)/(lag(PRC)/lag(CFACPR)))-1),6)) %>% 
  ungroup()
  
#evaluating whether this calculation was successful
summary(testing$RETX==testing$RETX_rep)

#we find NAs for the first REPX of each TICKER, which makes sense since there is no prior period - these are recoded to 0
testing[is.na(testing)] <- 0

#there are 62 values for which my REPX_rep does not match REPX

```

> 3. Use the holding period returns to create a total return index for the MSFT and GE stocks and the S&P 500 index, which shows the theoretical growth in value of an investment in the stock assuming that dividends are reinvested (normalize the start value to 1). Do the same for the returns that abstract from dividend payments (i.e., use RETX instead). Plot the investments with and without dividends for each stock separately. How do dividends affect the results stock by stock?

```{r creating_total_RET_indexes}

MSFT_monthly <-PS1_Monthly %>% 
  group_by(TICKER) %>% 
  filter(TICKER=="MSFT") %>% 
  mutate(TR_RET = cumprod(1*(1+RET)))

GE_monthly <-PS1_Monthly %>% 
  group_by(TICKER) %>% 
  filter(TICKER=="GE") %>% 
  mutate(TR_RET = cumprod(1*(1+RET)))

SP500_monthly <-PS1_Monthly %>% 
  group_by(DATE) %>% 
  unique() %>% 
  mutate(TR_RET = cumprod(1*(1+sprtrn)))

```

```{r creating_total_RETX_indexes}

MSFT_monthly <-MSFT_monthly %>% 
  group_by(TICKER) %>% 
  filter(TICKER=="MSFT") %>% 
  mutate(TR_RETX = cumprod(1*(1+RETX)))

GE_monthly <-GE_monthly %>% 
  group_by(TICKER) %>% 
  filter(TICKER=="GE") %>% 
  mutate(TR_RETX = cumprod(1*(1+RETX)))

```

```{r plotting_monthly_total_return_indexes}

#(monthly) plotting MSFT and GE in comparison to each other and SP500
monthly_returns <- ggplot()+
  geom_line(data=MSFT_monthly,aes(x=DATE,y=TR_RET),color="orange")+
  geom_line(data=GE_monthly,aes(x=DATE,y=TR_RET),color="purple")+
  geom_line(data=SP500_monthly,aes(x=DATE,y=TR_RET),color="gray45")+
  theme_fivethirtyeight() + theme(axis.title=element_text())+
  labs(title="Monthly Total Returns Comparison", subtitle="Monthly Total Return Index, Normalised to $1 Investment for <span style='color:orange;'>MSFT</span>, <span style='color:purple;'>GE</span> and the <span style='color:gray45;'>S&P500</span> </span>",x="Date",y="Total Return")+
  scale_x_date(date_breaks="2 years",date_labels="%Y")+
  scale_y_continuous(labels=scales::dollar_format(), breaks=seq(0,120,by=10), limits=c(0,120))+
  theme(plot.subtitle = element_markdown())

monthly_returns

```

```{r plotting_monthly_total_return_indexes_dividends, fig.height=7, fig.width=7}

#for MSFT both with and without dividends
ggplot()+
  geom_line(data=MSFT_monthly,aes(x=DATE,y=TR_RET),color="red")+
  geom_line(data=MSFT_monthly,aes(x=DATE,y=TR_RETX),color="blue")+
  theme_fivethirtyeight() + theme(axis.title=element_text())+
  labs(title="MSFT | Microsoft Corporation", subtitle="Monthly Total Return Index, Normalised to $1 Investment, <span style='color:red;'>Including Dividends</span> and <span style='color:blue;'>Excluding Dividends</span> </span>",x="Date",y="Total Return")+
  scale_y_continuous(labels=scales::dollar_format(), breaks=seq(0,120,by=10))+
  scale_x_date(date_breaks="2 years",date_labels="%Y")+
  theme(plot.subtitle = element_markdown())

#for GE both with and without dividends
ggplot()+
  geom_line(data=GE_monthly,aes(x=DATE,y=TR_RET),color="red")+
  geom_line(data=GE_monthly,aes(x=DATE,y=TR_RETX),color="blue")+
  theme_fivethirtyeight() + theme(axis.title=element_text())+
  labs(title="GE | General Electric Company", subtitle="Monthly Total Return Index Normalised to $1 Investment, <span style='color:red;'>Including Dividends</span> and <span style='color:blue;'>Excluding Dividends</span> </span>",x="Date",y="Total Return")+
  scale_y_continuous(labels=scales::dollar_format(), breaks=seq(0,16,by=2), limits=c(0,16))+
  scale_x_date(date_breaks="2 years",date_labels="%Y")+
  theme(plot.subtitle = element_markdown())

```

These two plots clearly demonstrate that including dividends results in a substantially higher total return over time for both stocks surveyed. 

Notably (as we would expect), the divergence of total returns including dividends from total returns excluding dividends increases consistently over the period as the returns accruing from dividends compound. More specifically, for MSFT, the inclusion of dividend payments results in a total return of \$115 over the entire period from the initial \$1 investment, over 1.5x greater than the return excluding dividend payments, of just \$74. Similarly, for GE, the full-period return including dividends is approximately \$10 is 2x greater than that excluding dividend payments, of just \$4.9. 

Thus, arguably dividends have a greater effect on total returns across the full period for GE stock than MSFT stock, despite MSFT having considerably larger total returns overall. Again, this is to be expected, since MSFT only began to issue dividends in January 2003, while GE issued dividends throughout the period surveyed, allowing total returns accruing from dividends to compound over a considerably longer time period. 

> 4.  Normalize the price of GE using the adjusted number of shares. Plot the adjusted price against the unadjusted prices. Discuss.

```{r normalizing_monthly_GE_price, fig.height=7, fig.width=7}

#normalizing the price by adjusting for number of shares
GE_monthly <- GE_monthly %>% 
  mutate(PRC_norm = PRC/CFACPR)

#plotting the adjusted prices against the unadjusted prices
ggplot()+
  geom_line(data=GE_monthly,aes(x=DATE,y=PRC),color="red")+
  geom_line(data=GE_monthly,aes(x=DATE,y=PRC_norm),color="blue")+
  theme_fivethirtyeight() + theme(axis.title=element_text())+
  labs(title="GE | General Electric Company", subtitle="<span style='color:red;'>Nominal Price</span> and <span style='color:blue;'>Share-Adjusted Price</span> </span>",x="Date",y="Price")+
  scale_x_date(date_breaks="2 years",date_labels="%Y")+
  scale_y_continuous(labels=scales::dollar_format(), breaks=seq(0,160,by=20), limits=c(0,160))+
  theme(plot.subtitle = element_markdown())

```

Reviewing the relationship between GE's nominal and adjusted share prices, it is clear by the steep and immediate drop in nominal share price, to the exact level of the adjusted share price, that there was a stock split. Indeed, this drop from approximately \$160 per share, to approximately \$55 per share, is consistent with GE's 3 for 1 stock split in mid-2000, as discussed in GE's [2000 Annual Report](https://www.annualreports.com/HostedData/AnnualReportArchive/g/NYSE_GE_2000.pdf "2000 Annual Report"){target="_blank"}. 

> 5.  The holding period returns are normal returns. Generate a new variable that contains the corresponding log returns (LRET). Calculate the mean, variance, skewness, and kurtosis of the normal and the log returns. Plot the normal against the log returns for MSFT. Briefly discuss your results!

```{r log_monthly_returns}

#creating the log returns variable, LRET = ln(1+RET) = ln(PRC/lag(PRC))
PS1_Monthly <- PS1_Monthly %>% 
    mutate(LRET=log(1+RET)) 

#calculating the mean, variance, skewness, and kurtosis of the normal (RET) and the log (LRET) returns
statistics_monthly <- PS1_Monthly %>% 
    group_by(TICKER) %>% 
  
#using the library(PerformanceAnalytics) to calculate the statistics
    summarise(
      
      mean_normal = mean(RET),
      variance_normal = var(RET),
      skewness_normal = skewness(RET),
      kurtosis_normal = kurtosis(RET),
      
      mean_log = mean(LRET),
      variance_log = var(LRET),
      skewness_log = skewness(LRET), 
      kurtosis_log = kurtosis(LRET)
      
      )

print(statistics_monthly)

```

These distributions demonstrate how the logged returns of key assets such as MSFT and GE are more leptokurtic (with fatter tails) than the normal returns, and more negatively skewed. This is to be expectedm since taking the log of returns adjusts for the effect of a substantial number of positive outliers. Aside from kurtosis and skew (which is represented by the logged mean return being consistently smaller than the normal mean return), the variance of the normal returns and logged returns are similar: the logged return variance being only marginally smaller than the normal return variance, again due to mitgation of the effects of outliers at the positive extreme. 

```{r MSFT_monthly_returns_plot, fig.height=7, fig.width=7}

#(further) adding the total returns LRET series for MSFT
MSFT_monthly <-MSFT_monthly %>% 
  mutate(LRET=log(1+RET))

#plotting normal and log returns for MSFT
ggplot()+
  geom_line(data=MSFT_monthly,aes(x=DATE,y=RET),color="red")+
  geom_line(data=MSFT_monthly,aes(x=DATE,y=LRET),color="blue")+
  theme_fivethirtyeight() + theme(axis.title=element_text())+
  labs(title="MSFT | Microsoft Corporation", subtitle="<span style='color:red;'>Normal Returns</span> and <span style='color:blue;'>Log Returns</span> </span>",x="Date",y="Return")+
  scale_x_date(date_breaks="2 years",date_labels="%Y")+
  scale_y_continuous(labels=scales::percent_format(), breaks=seq(-0.4,0.4,by=0.05), limits=c(-0.4,0.4))+
  theme(plot.subtitle = element_markdown())

```

This plot demonstrates how logged returns closely approximate normal returns. However, consistent with the statistical distributions themselves, normal return peaks are marginally higher than those for logged returns, which adjust for outliers at the positive extreme. This means that, statistically, logged returns have marginally lower: mean and variance, and less positive (more negative) skewness, than normal returns. 

> 6. Go to CANVAS and download the data for PS1 Daily.xlsx. This file contains two worksheets. HPR Daily contains the daily holding period returns for the six stocks, the S&P 500 Composite Index and the value-weighted market portfolio (including dividends) from CRSP. Prices Daily contains the prices for the six stocks and the S&P 500 Composite Index.

```{r loading_daily_data}

HPR_daily <- read_xlsx("PS1_Daily.xlsx", sheet = "HPR_daily", skip = 1) %>% 
    mutate(DATE = lubridate::ymd(DATE))  # fix `date`

Prices_daily <- read_xlsx("PS1_Daily.xlsx", sheet = "Prices_daily", skip = 1) %>% 
    mutate(DATE = lubridate::ymd(DATE))  # fix `date`

```

```{r pivoting_data_for_usability}

#privoting prices daily
Prices_daily_long <-Prices_daily %>% 
  pivot_longer(cols = c(2:8),names_to = "TICKER",values_to = "PRC") 

#pivoting holding period returns
HPR_daily_long <-HPR_daily %>% 
  pivot_longer(cols = c(2:9),names_to = "TICKER",values_to = "HPR")

```

> 7. Construct a daily total return index for MSFT and GE stocks and the S&P 500 index and plot them against each other. Compare your results with the monthly total return indices from above. Are there any differences? Discuss.

```{r creating_daily_total_RET_indexes}

#creating MSFT daily total return index
MSFT_daily <-HPR_daily_long %>% 
  group_by(TICKER) %>% 
  filter(TICKER=="MSFT") %>% 
  mutate(TR_RET = cumprod(1*(1+HPR)))

#creating GE daily total return index
GE_daily <-HPR_daily_long %>% 
  group_by(TICKER) %>% 
  filter(TICKER=="GE") %>% 
  mutate(TR_RET = cumprod(1*(1+HPR)))
    
#creating SP500 daily total return index
SP500_daily <-HPR_daily_long %>% 
  group_by(TICKER) %>% 
  filter(TICKER=="SPRTRN") %>% 
  mutate(TR_RET = cumprod(1*(1+HPR)))
    
```

```{r plotting_daily_total_return_indexes}

#(daily) plotting MSFT and GE in comparison to each other and SP500
daily_returns <- ggplot()+
  geom_line(data=MSFT_daily,aes(x=DATE,y=TR_RET),color="orange")+
  geom_line(data=GE_daily,aes(x=DATE,y=TR_RET),color="purple")+
  geom_line(data=SP500_daily,aes(x=DATE,y=TR_RET),color="gray45")+
  theme_fivethirtyeight() + theme(axis.title=element_text())+
  labs(title="Daily Total Returns Comparison", subtitle="Daily Total Return Index, Normalised to $1 Investment for <span style='color:orange;'>MSFT</span>, <span style='color:purple;'>GE</span> and the <span style='color:gray45;'>S&P500</span> </span>",x="Date",y="Total Return")+
  scale_x_date(date_breaks="2 years",date_labels="%Y")+
  scale_y_continuous(labels=scales::dollar_format(), breaks=seq(0,120,by=10), limits=c(0,120))+
  theme(plot.subtitle = element_markdown())

daily_returns

```

```{r plotting_total_return_indexes, fig.height=10, fig.width=20}

#plotting the two alongside one another
daily_returns+monthly_returns

```

Comparing the daily and monthly total return indexes shown above, it is clear that each asset demonstrates effectively identical trends over the course of the period. However, volatility is evidently (and expectedly) higher in daily returns than monthly returns, and due to the 

has the greatest impact on the S&P500. 


> 8. As before, the holding period returns are normal returns. Create log returns. Calculate the mean, variance, skewness, and kurtosis of the normal and log returns. Compare and discuss your results with the results from monthly frequency

```{r log_daily_returns}

#creating the log returns variable, LRET = ln(1+RET) = ln(PRC/lag(PRC))
HPR_daily_long <-HPR_daily_long %>% 
  mutate(LRET=log(1+HPR))

#calculating the mean, variance, skewness, and kurtosis of the normal (RET) and the log (LRET) returns
statistics_daily <- HPR_daily_long %>% 
    group_by(TICKER) %>% 
  
#using the library(PerformanceAnalytics) to calculate the statistics
    summarise(
      
      mean_normal = mean(HPR),
      variance_normal = var(HPR),
      skewness_normal = skewness(HPR),
      kurtosis_normal = kurtosis(HPR),
      
      mean_log = mean(LRET),
      variance_log = var(LRET),
      skewness_log = skewness(LRET), 
      kurtosis_log = kurtosis(LRET)
      
      )

print(statistics_daily)

```


> 9.  Compare the statistical properties of the log holding period return time series both for monthly and daily returns. Plot a histogram and discuss how the empirical distributions relate to the normal distribution.

```{r}


```

> 10.  Pick three stocks and the S&P 500 index (either you can use MSFT, GE and JPM or adapt the code to pick three random stocks). You will need the holding period returns (both normal and log returns) and the total return indices you created.

```{r}



```

> 11.  Calculate the covariance matrix for the log return series, using both the returns and returns squared. Discuss your results briefly.

```{r}



```

> 12. Plot the ACF (autocorrelation function) for prices, returns, returns squared, and absolute returns. Discuss the results!

```{r}



```

> 13. Use the three assets and make up a portfolio by assigning arbitrary portfolio weights. What does it imply if you keep the weights fixed over time?

```{r}



```

> 14.  Calculate the portfolio returns and use them to calculate the evolution of a $ 1 investment in the portfolio over the sample period. Plot the result against the evolution of a $ 1 investment in each of the three stocks. Discuss the result.

```{r}



```

> 15.  Portfolio theory with matrix algebra

```{r}



```

> 15.a Calculate the means, the variance and the pairwise covariances for the three stocks MSFT, GE, and
JPM for the sample period between 2/1/1990 and 31/12/2002.

> 15.b Define the following matrices that contain returns, expected returns, portfolio weights, and covariances:

> 15.c Note that the expected portfolio return and variance equal:

> 15.d Calculate the return and standard deviation of a portfolio where you equal-weight the three stocks
- call the portfolio e. Additionally, consider a portfolio y with a weight vector y’ = (0.8, 0.4, −0.2).
Calculate the risk-return tradeoff of y as well as its covariance with portfolio e.

> 15.e In order to find the global minimum variance portfolio with weights m’ = (mMSF T , mGE, mJPM ),
we have to solve the following problem

> 15.f Find another efficient portfolio. Namely, the efficient portfolio that gives a return equal to the
expected return of MSFT. Note, that your minimization problem now becomes:

> 15.g Derive the solution as above in terms of portfolio weights and calculate them in your code. In
addition, calculate the expected return and the variance of efficient portfolio x as well as its
covariance with the global minimum portfolio.

> 15.h Plot the entire efficient frontier for the three risky assets.

> 15.i Now, rerun your code with sample moments for the three stocks MSFT, GE, and JPM for the sample
period between 2/1/2003 and 31/12/2014.

> 15.j Finally, compare your results for the three assets across the two sample periods. Comment on
potential problems that might arise when you based investment decisions on your analysis. Also
discuss potential solutions to the problems mentioned.















